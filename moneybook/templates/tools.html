{% extends "_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ app_name }} Tools{% endblock %}

{% block header %}
<script type="text/javascript" src="{% static 'common.js' %}"></script>
<script type="text/javascript" src="{% static 'tools.js' %}"></script>
<script type="text/javascript">
    update_actual_cash_url = "{% url 'moneybook:update_actual_cash' %}";
    update_checked_date_url = "{% url 'moneybook:update_checked_date' %}";
    update_fixed_cost_mark_url = "{% url 'moneybook:update_fixed_cost_mark' %}";
    edit_check_url = "{% url 'moneybook:edit_check' %}";

    window.onload = function() {
        show_diff();
        calculate_now_bank();
    }
    
    function calculate_now_bank() {
        $.ajax({
            url: "{% url 'moneybook:calculate_now_bank' %}",
            type: "POST",
            data: {
                "csrfmiddlewaretoken": $('input[name="csrfmiddlewaretoken"]').val(),
                {% for b in banks %}
                    "bank-{{ b.pk }}": unseparate($("#bank-{{ b.pk }}").val()),{% endfor %}
                {% for c in credit_checked_date %}
                    "credit-{{ c.pk }}": unseparate($("#credit-{{ c.pk }}").val()),{% endfor %}
            }
        })
        .done((data) => {
            result = JSON.parse(data);
            $("#now_bank_balance").text(separate(result["balance"]));
            document.activeElement.blur();
        })
        .fail((data) => {
            // メッセージ表示
            show_result_msg("Error...", empty);
        });
    }
    function key_press_now_bank(code) {
        // エンターキーなら
        if (code === 13) {
            calculate_now_bank();
        }
    }
</script>
{% endblock %}

{% block content %}
{% csrf_token %}
<section>
    <h1>現金差額計算</h1>
    <table class="tbl-common">
        <tr>
            <th>記録</th>
            <td id="written_balance" class="righter">{{ cash_balance| intcomma }}</td>
        </tr>
        <tr>
            <th>実際</th>
            <td><input type="text" class="righter" id="actual_balance" style="width:10ex" onfocus="delete_value('actual_balance')" onblur="separate_value('actual_balance')" onkeypress="key_press_diff(event.keyCode)" value="{{ actual_cash_balance| intcomma }}"></td>
        </tr>
        <tr><th>差額</th><td id="balance_diff" class="righter"></td></tr>
    </table>
    <input type="button" class="btn-apply" value="計算" onclick="update_diff()" onkeypress="key_press_diff(event.keyCode)">

    <h1>確認済み日付</h1>
    <table class="tbl-add tbl-common">
        <tr>
            <td colspan="3">
                <input type="text" style="width:6ex" class="righter" id="check_year" value="{{ year }}">年
                <input type="text" style="width:5ex" class="righter" id="check_month" value="{{ month }}">月
                <input type="text" style="width:5ex" class="righter" id="check_day" value="{{ day }}">日
            </td>
        </tr>
        {% for m in methods_bd %}
            <tr>
                <td><input type="button" class="btn-apply" value="{{ m.method.name }}" onclick="update_checked_date({{ m.method.pk }}, {% if m.method.pk == 2 %}0{% else %}1{% endif %})"></td>
                <td>現在: {{ m.date|date:"Y"}}年{{ m.date|date:"m" }}月{{ m.date|date:"d" }}日</td>
                <td class="righter">{{ m.balance|intcomma }}円</td>
            </tr>
        {% endfor %}
    </table>

    <h1>各種確認日</h1>
    <table class="tbl-add tbl-common">
        <tr>
            <td colspan="3">
                <input type="text" style="width:6ex" class="righter" id="credit_check_year" value="{{ year }}">年
                <input type="text" style="width:5ex" class="righter" id="credit_check_month">月
                <input type="text" style="width:5ex" class="righter" id="credit_check_day">日
            </td>
        </tr>
        {% for c in credit_checked_date %}
            <tr>
                <td><input type="button" class="btn-apply" value="{{ c.name }}" onclick="update_several_checked_date({{ c.pk }}, '{% url "moneybook:update_credit_checked_date" %}')"></td>
                <td>最新確定引き落とし日: {{ c.date|date:"Y"}}年{{ c.date|date:"m" }}月{{ c.date|date:"d" }}日</td>
            </tr>
        {% endfor %}
        {% for c in cacheback_checked_date %}
            <tr>
                <td><input type="button" class="btn-apply" value="{{ c.name }}" onclick="update_several_checked_date({{ c.pk }}, '{% url "moneybook:update_cacheback_checked_date" %}')"></td>
                <td>キャッシュバック確認: {{ c.date|date:"Y"}}年{{ c.date|date:"m" }}月{{ c.date|date:"d" }}日</td>
            </tr>
        {% endfor %}
    </table>

    <h1>固定費目標額</h1>
    <table class="tbl-common">
        <tr>
            <td><input type="text" class="righter" id="txt_fixed_cost" style="width:10ex" onfocus="unseparate_value('txt_fixed_cost')" onblur="separate_value('txt_fixed_cost')" onkeypress="key_press_fixed(event.keyCode)" value="{{ fixed_cost_mark| intcomma }}"></td>
            <td><input type="button" value="更新" class="btn-apply" onclick="update_fixed_cost_mark()" onkeypress="key_press_fixed(event.keyCode)"></td>
        </tr>
    </table>

    <h1 id="unchecked-transaction">未承認トランザクション</h1>
    <table class="tbl-inout tbl-boarder">
        <tr><th>日付</th><th>品目</th><th>金額</th><th>支払い方法</th><th>分類</th><th>編集</th><th>チェック</th></tr>
        {% for d in unchecked_data %}
        <tr class="data-row" id="unapproved-row-{{ d.pk }}">
            <td>{{ d.date|date:"Y/m/d" }}</td>
            <td class="lefter">{{ d.item }}</td>
            <td class="righter">{{ d.price|intcomma }}</td>
            <td>{{ d.method }}</td>
            <td>{% if d.temp %}立替{% else %}{{ d.genre }}{% endif %}</td>
            <td class='a-edit'><a href="{% url 'moneybook:edit' d.pk %}">編集</a></td>
            <td class="a-edit"><input type="button" value="OK" onclick="check({{ d.pk }})" style="cursor:pointer"></td>
        </tr>
        {% endfor %}
    </table>

    <h1>現在銀行計算</h1>
    <table class="tbl-common">
        <tr>
            <th>記録</th>
            <td>{{ bank_written| intcomma }}</td>
        </tr>
        <tr><th class="space"></th><td class="space"></td></tr>
        {% for b in banks %}
            <tr>
                <th>{{ b.name }}</th>
                <td><input type="text" class="righter" id="bank-{{ b.pk }}" style="width:7ex" onfocus="unseparate_value('bank-{{ b.pk }}')" onblur="separate_value('bank-{{ b.pk }}')" onkeypress="key_press_now_bank(event.keyCode)" value="{{ b.price| intcomma }}"></td>
            </tr>
        {% endfor %}
        {% for c in credit_checked_date %}
            <tr>
                <th>{{ c.name }}</th>
                <td><input type="text" class="righter" id="credit-{{ c.pk }}" style="width:7ex" onfocus="unseparate_value('credit-{{ c.pk }}')" onblur="separate_value('credit-{{ c.pk }}')" onkeypress="key_press_now_bank(event.keyCode)" value="{{ c.price| intcomma }}"></td>
            </tr>
        {% endfor %}
        <tr><th class="space"></th><td class="space"></td></tr>
        <tr>
            <th>差額(記録-予定)</th>
            <td id="now_bank_balance"></td>
        </tr>
    </table>
    <input type="button" class="btn-apply" value="計算" onclick="calculate_now_bank()" />
</section>
{% include "_result_message.html" %}
{% endblock %}